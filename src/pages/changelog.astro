---
import Footer from '../components/Footer.astro';
import Layout from '../layouts/Layout.astro';
import MarkdownIt from 'markdown-it';
import 'highlight.js/styles/github-dark.css';

const changelogUrl = 'https://raw.githubusercontent.com/Ewwii-sh/ewwii/main/CHANGELOG.md';
let markdown = '';
try {
  const res = await fetch(changelogUrl);
  markdown = await res.text();
} catch {
  markdown = '# Error\nFailed to load changelog.';
}

// Configure markdown-it with syntax highlighting
const md = new MarkdownIt({
  html: true,
  linkify: true,
  typographer: true,
  breaks: true, // convert line breaks in lists to <br> if needed
});

// Split into version sections
const versionSections = markdown
  .split(/\n(?=## \[)/)
  .map(section => {
    // skip main title
    if (/^# Changelog/.test(section)) return null;

    const titleMatch = section.match(/^## \[(.*?)\]/m);
    const version = titleMatch ? titleMatch[1] : 'Unknown';
    const html = md.render(section);
    return { version, html };
  })
  .filter(Boolean); 

---
<Layout>
  <section class="flex flex-col md:flex-row min-h-screen bg-[#212223] text-[#f5f5f5] relative">

    <!-- Mobile top bar -->
    <div class="md:hidden flex justify-between items-center p-4 bg-[#1e1f21] border-b border-gray-700">
      <h2 class="text-xl font-bold">Versions</h2>
      <button id="toggleSidebar" class="px-2 py-1 bg-[#ff914c] text-[#212223] rounded" aria-expanded="false">â˜°</button>
    </div>

    <!-- Sidebar -->
    <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-40 z-40 hidden md:hidden"></div>

    <aside id="sidebar" class="fixed left-0 top-0 w-64 h-full bg-[#1e1f21] z-50 transform -translate-x-full transition-transform duration-300 md:relative md:translate-x-0 md:w-1/4 md:block">
      <h2 class="text-2xl font-bold p-4">Versions</h2>
      <ul class="flex flex-col gap-2">
        {versionSections.map((v, i) => (
          <li>
            <button
              class="w-full text-left px-3 py-2 rounded hover:bg-[#3a3b3d] transition version-btn"
              data-index={i}
            >
              {v!.version}
            </button>
          </li>
        ))}
      </ul>
    </aside>

    <!-- Resizer for desktop -->
    <div id="resizer" class="hidden md:block w-2 cursor-col-resize bg-gray-700"></div>

    <!-- Main content -->
    <main id="content" class="flex-1 p-6 overflow-y-auto space-y-8">
      <a href="/" class="inline-block mb-4 px-4 py-2 bg-[#ff914c] text-[#212223] rounded hover:bg-[#e6853f] transition">
        &laquo; Return Home
      </a>

      {versionSections.map((v, i) => (
        <div
          id={`version-${i}`}
          class={`version-content ${i === 0 ? '' : 'hidden'}`}
          set:html={v!.html}
        />
      ))}
    </main>
  </section>

  <!-- Scripts -->
  <script>
    // Version switching
    const buttons = document.querySelectorAll('.version-btn');
    const panels = document.querySelectorAll('.version-content');
    buttons.forEach(btn => {
      btn.addEventListener('click', () => {
        const element = btn as HTMLElement;
        const index = element.dataset.index;
        panels.forEach(p => p.classList.add('hidden'));
        document.getElementById('version-' + index)?.classList.remove('hidden');
        buttons.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
      });
    });
    if (buttons.length > 0) buttons[0].classList.add('active');

    // Sidebar toggle (mobile)
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('sidebar-overlay');
    const toggleBtn = document.getElementById('toggleSidebar');
    function openSidebar() {
      sidebar!.classList.remove('-translate-x-full');
      overlay!.classList.remove('hidden');
      toggleBtn!.setAttribute('aria-expanded', 'true');
    }

    function closeSidebar() {
      sidebar!.classList.add('-translate-x-full');
      overlay!.classList.add('hidden');
      toggleBtn!.setAttribute('aria-expanded', 'false');
    }

    toggleBtn?.addEventListener('click', () => {
      if (sidebar!.classList.contains('-translate-x-full')) {
        openSidebar();
      } else {
        closeSidebar();
      }
    });

    overlay?.addEventListener('click', closeSidebar);

    buttons.forEach(btn => {
      btn.addEventListener('click', () => {
        if (window.innerWidth < 768) closeSidebar();
      });
    });


    // Draggable resizer (desktop only)
    const resizer = document.getElementById('resizer');
    resizer?.addEventListener('mousedown', (_) => {
      if (window.innerWidth < 768) return; // ignore on mobile
      document.body.style.userSelect = 'none';
      document.addEventListener('mousemove', doDrag);
      document.addEventListener('mouseup', stopDrag);
    });

    function doDrag(e: any) {
      const newWidth = e.clientX;
      if (newWidth > 100 && newWidth < window.innerWidth - 100) {
        sidebar!.style.width = newWidth + 'px';
      }
    }

    function stopDrag() {
      document.removeEventListener('mousemove', doDrag);
      document.removeEventListener('mouseup', stopDrag);
      document.body.style.userSelect = '';
    }
  </script>

  <Footer />
</Layout>

<style is:global>
.version-btn:hover {
  background-color: #3a3b3d;
}

.version-btn.active {
  background-color: #ff914c;
  color: #212223;
}

.version-btn.active:hover {
  background-color: #ffb380;
}

@media (max-width: 767px) {
  #sidebar {
    position: absolute;
    z-index: 50;
    height: 100%;
    left: 0;
    top: 0;
    background: #1e1f21;
    transition: transform 0.3s ease;
    transform: translateX(-100%);
  }
  #sidebar:not(.hidden) {
    transform: translateX(0);
  }
}

.version-content {
  transition: all 0.3s ease;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
  color: #f5f5f5;
  line-height: 1.6;
}

/* Headings */
.version-content h1 { font-size: 2.5rem; font-weight: bold; margin: 1.5rem 0 1rem; }
.version-content h2 { font-size: 2rem; font-weight: bold; margin: 1.5rem 0 1rem; }
.version-content h3 { font-size: 1.75rem; font-weight: bold; margin: 1.25rem 0 0.75rem; }
.version-content h4 { font-size: 1.5rem; font-weight: bold; margin: 1.1rem 0 0.6rem; }
.version-content h5 { font-size: 1.25rem; font-weight: bold; margin: 1rem 0 0.5rem; }
.version-content h6 { font-size: 1rem; font-weight: bold; margin: 0.75rem 0 0.25rem; }

/* Paragraphs */
.version-content p { margin: 0.75rem 0; }

/* Lists */
.version-content ul,
.version-content ol { margin: 0.75rem 0 0.75rem 1.5rem; padding: 0; }
.version-content li { margin: 0.25rem 0; }

/* Blockquotes */
.version-content blockquote {
  border-left: 4px solid #ff914c;
  padding-left: 1rem;
  color: #d0d0d0;
  font-style: italic;
  margin: 1rem 0;
  background-color: #1e1f21;
  border-radius: 0.25rem;
}

/* Code & Preformatted */
.version-content pre {
  background-color: #1e1f21;
  padding: 1rem;
  border-radius: 0.5rem;
  overflow-x: auto;
  font-size: 0.9rem;
}
.version-content code {
  background-color: #2a2b2d;
  padding: 0.1rem 0.3rem;
  border-radius: 0.25rem;
  font-family: "Fira Code", monospace;
}

/* Tables */
.version-content table {
  width: 100%;
  border-collapse: collapse;
  margin: 1rem 0;
}
.version-content th,
.version-content td {
  border: 1px solid #444;
  padding: 0.5rem 1rem;
  text-align: left;
}
.version-content th {
  background-color: #2a2b2d;
}
.version-content tr:nth-child(even) td {
  background-color: #1e1f21;
}

/* Links */
.version-content a {
  color: #ff914c;
  text-decoration: underline;
}
.version-content a:hover {
  text-decoration: none;
}

/* Horizontal rules */
.version-content hr {
  border: none;
  border-top: 1px solid #444;
  margin: 2rem 0;
}

/* Images */
.version-content img {
  max-width: 100%;
  border-radius: 0.5rem;
  margin: 1rem 0;
}

/* Inline elements */
.version-content strong { font-weight: bold; }
.version-content em { font-style: italic; }
.version-content del { text-decoration: line-through; }

/* Lists inside lists */
.version-content ul ul,
.version-content ol ol,
.version-content ul ol,
.version-content ol ul {
  margin-top: 0;
  margin-bottom: 0;
}
</style>
